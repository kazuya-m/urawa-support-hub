# urawa-support-hub 要件定義書

## 1. システム概要

浦和レッズサポーター向け総合支援ツール「urawa-support-hub」として、アウェイ戦チケット販売情報を自動監視し、販売開始前にLINEグループチャットへリマインド通知を送信するシステムを構築する。

## 2. 機能要件

### 2.1 監視機能

- **監視対象**: Jリーグチケットサイト 浦和レッズページのAWAYタブ
  - メインURL: `https://www.jleague-ticket.jp/club/ur/`
  - AWAYタブ: `https://www.jleague-ticket.jp/club/ur/?tab=away`（推定）
- **監視頻度**: 1日1回、毎日12:00 JST（03:00 UTC）に実行
- **監視期間**: 通年実行、12月（シーズンオフ）を除く（1月〜11月）
- **対象チケット**:
  - 「ビジター」「ミックス」「アウェイ」「バックアウェイ」「メインアウェイ」のいずれかを含む席種
  - 「一般販売」に限定（先行販売は除外）

### 2.2 通知機能

- **通知先**: LINEグループチャット
- **通知タイミング**:
  1. 販売開始日前日の20:00 JST
  2. 販売開始時刻の1時間前
  3. 販売開始時刻の15分前

- **通知内容**:
  - 試合名（例：「FC東京 vs 浦和レッズ」）
  - 試合日時
  - 販売開始日時
  - チケット購入URL
  - 会場名

### 2.3 データ管理機能

- チケット販売情報の取得・解析
- 既存データとの差分検出（新規・更新判定）
- 通知履歴の管理（重複通知防止）
- 試合日が過ぎたデータの自動削除（試合日から7日後）

### 2.4 システム監視機能

- **エラー監視**: 全機能の実行時エラーを即座にキャッチ・通知
- **健康状態監視**: システムメトリクスの定期収集・評価
- **Discord通知**:
  - エラーレベル別通知（warning/error/critical）
  - システム状態レポート（healthy/degraded/down）
  - リッチEmbed形式での詳細情報表示
- **ログ管理**:
  - 構造化ログの永続化
  - エラー傾向の分析・レポート
  - デバッグ支援情報の保存

### 2.5 通知システム統合

- **ユーザー向け通知**: LINE（チケット販売情報）
- **開発者向け通知**: Discord（システム状態・エラー）
- **重複防止**: 通知種別・対象別の重複チェック
- **再試行機能**: 通知失敗時の自動再試行（最大3回、指数バックオフ）

## 3. 非機能要件

### 3.1 性能要件

- **実行時間**: 60秒以内（Supabase Edge Functions制限）
- **メモリ使用量**: 512MB以内
- **応答時間**: スクレイピング処理30秒以内

### 3.2 可用性要件

- **稼働率**: 99%以上（12月除く）
- **障害対応**: 自動復旧機能（フォールバックURL）
- **データ整合性**: 重複通知の完全防止

### 3.3 監視要件

- **エラー検出時間**: 5分以内（実行時エラー）
- **通知送信時間**: 30秒以内（Discord/LINE）
- **ログ保持期間**: 90日間（エラー分析用）
- **メトリクス収集頻度**: 5分間隔

### 3.4 アラート要件

- **エラーレベル別対応**:
  - warning: Discord通知のみ
  - error: Discord通知 + ログ記録
  - critical: Discord通知 + ログ記録 + スタックトレース
- **エスカレーション**:
  - 連続3回のcriticalエラー → 特別アラート
  - 24時間で10回以上のerror → システム劣化警告

### 3.5 保守性要件

- 外部サービス変更に対する耐性（リポジトリパターン採用）
- 設定変更の容易性（環境変数・設定ファイル活用）
- 構造化ログ出力によるデバッグ支援
- エラー傾向分析による予防保守

## 4. 制約事項

### 4.1 技術制約

- Supabase無料枠内での運用（2プロジェクト制限）
- Playwright使用による512MBメモリ制限
- JavaScript必須サイトに対するスクレイピング制約

### 4.2 法的制約

- robots.txt準拠
- 適切なアクセス頻度（1日1回）
- サイト利用規約の遵守

## 5. 成功基準

- **検出精度**: アウェイ戦チケット販売情報の100%検出
- **通知成功率**: 95%以上（LINE）
- **エラー検出率**: 100%（システム監視）
- **システム稼働率**: 99%以上（12月除く）
- **運用コスト**: 月額$0（全て無料枠内）
- **平均復旧時間**: 24時間以内（エラー発生から修正まで）

## 6. 想定リスク

### 6.1 技術的リスク

- **Jリーグチケットサイトの構造変更**
  - 影響度: 高
  - 対策: 複数セレクタパターン、フォールバック機能、Discord即座通知

- **Discord/LINE API制限・障害**
  - 影響度: 中
  - 対策: 相互補完システム、送信頻度制限、エラー処理

- **Supabase無料枠超過**
  - 影響度: 中
  - 対策: 使用量監視、効率的実装、アラート機能

- **メモリ制限超過（512MB）**
  - 影響度: 中
  - 対策: メモリ監視、最適化、軽量フォールバック

### 6.2 運用的リスク

- **スクレイピング対象サイトのアクセス制限**
  - 影響度: 高
  - 対策: 適切なアクセス頻度、User-Agent設定、即座のエラー通知

- **長期間のシステム停止**
  - 影響度: 中
  - 対策: 自動監視体制、Discord通知、自動復旧機能

- **エラーの見落とし・対応遅延**
  - 影響度: 中
  - 対策: リアルタイムDiscord通知、エスカレーション機能、構造化ログ

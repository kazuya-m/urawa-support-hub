# 技術選定書

## 技術スタック概要

### アーキテクチャの進化

システムは純粋なSupabaseアーキテクチャ（v1.0）から、ウェブスクレイピングワークロードのスケーラビリティと信頼性要件に対応するため、ハイブリッドGCP +
Supabaseアーキテクチャ（）に進化しました。

## コア技術スタック

### 実行環境

- **Deno + TypeScript**: 内蔵TypeScriptサポートを持つモダンランタイム
- **理由**: 型安全性、モダンなJavaScript機能、デフォルトセキュア
- **用途**: 全アプリケーションロジック、Edge Functions、Cloud Runサービス

### クラウドコンピューティングプラットフォーム

#### Google Cloud Platform (新規)

- **Google Cloud Run**: コンテナ化されたウェブスクレイピング実行環境
- **Google Cloud Scheduler**: 信頼性の高い日次トリガーメカニズム
- **Google Cloud Tasks**: イベント駆動通知スケジューリング
- **理由**: Playwrightのより良いリソース割り当て、自動スケーリング、コスト効率

#### Supabaseプラットフォーム

- **Supabase PostgreSQL**: REST APIを持つクラウドネイティブPostgreSQL
- **Supabase Edge Functions**: サーバーレス通知配信
- **Supabase PostgREST API**: スキーマからの自動生成REST API
- **理由**: 無料枠の利用可能性、リアルタイム機能、データベースとの統合

### データベース

- **Supabase PostgreSQL**: プライマリデータストレージ
- **理由**:
  - 無料枠の利用可能性
  - 内蔵行レベルセキュリティ（RLS）
  - リアルタイム購読機能
  - 自動生成REST API
  - Edge Functionsとの統合

### ウェブスクレイピング

- **Playwright**: モダンなブラウザ自動化ライブラリ
- **実行環境**: Google Cloud Run（Edge Functionsから変更）
- **理由**:
  - JavaScript実行サポートによる信頼性の高いスクレイピング
  - マルチブラウザサポート（Chromium、Firefox、WebKit）
  - Cloud Runでの十分なリソース割り当て（2GBメモリ）
  - 十分な実行時間（300秒タイムアウト）
  - コンテナベースデプロイメント

### 通知サービス

- **LINE Messaging API**: プライマリユーザー通知
- **Discord Webhook**: 開発者・システム監視とエラーアラート
- **理由**: ターゲットユーザーベースの好み、信頼性の高い配信、リッチフォーマット

### スケジューリングアーキテクチャ

#### ハイブリッドアプローチ

- **Google Cloud Scheduler**: 日次スクレイピングトリガー（12:00 JST）
- **Google Cloud Tasks**: 個別通知スケジューリング
- **理由**:
  - 外部サービスコールでpg_cronより信頼性が高い
  - イベント駆動通知（ポーリングなし）
  - 指数バックオフでのより良いリトライメカニズム
  - 自動デッドレターキューハンドリング

#### v1.0 アプローチ（非推奨）

- **pg_cron**: スケジュール済みタスクのためのPostgreSQL拡張
- **変更理由**: スクレイピングのメモリと実行時間制限

### アーキテクチャパターン

- **Clean Architecture**: 関心の明確な分離を持つドメイン駆動設計
- **リポジトリパターン**: データアクセス抽象化
- **設定駆動設計**: 外部化されたビジネスルールとタイミング
- **理由**: テスタビリティ、保守性、外部サービス独立性

## 技術比較

### スクレイピング実行環境

| 側面                   | Supabase Edge Functions (v1.0) | Google Cloud Run ()  |
| ---------------------- | ------------------------------ | -------------------- |
| **メモリ制限**         | 512MB                          | 2GB                  |
| **実行時間**           | 60秒                           | 300秒                |
| **コンテナサポート**   | Denoランタイムのみ             | 完全なDockerコンテナ |
| **Playwrightサポート** | 制限あり                       | 完全サポート         |
| **コールドスタート**   | ~100ms                         | ~1-2秒               |
| **コスト**             | 無料（50万リクエスト）         | 無料（18万vCPU秒）   |
| **信頼性**             | 良好                           | 優秀                 |

**決定**: より良いリソース割り当てとPlaywright互換性のためCloud Runを選択。

### スケジューリングメカニズム

| 側面                   | pg_cron (v1.0)   | Cloud Scheduler + Tasks () |
| ---------------------- | ---------------- | -------------------------- |
| **信頼性**             | データベース依存 | 独立サービス               |
| **リトライロジック**   | 手動実装         | 内蔵指数バックオフ         |
| **エラーハンドリング** | 制限あり         | デッドレターキュー         |
| **スケーラビリティ**   | データベース負荷 | 無制限タスクキューイング   |
| **コスト**             | 無料             | 無料（月100万タスク）      |
| **監視**               | PostgreSQLログ   | Cloud Console + ログ       |

**決定**: より良い信頼性とエラーハンドリングのためCloud Scheduler + Tasks。

## 技術依存関係

### ランタイム依存関係

```typescript
// コア依存関係（Deno）
import { serve } from 'https://deno.land/std@0.208.0/http/server.ts';
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2.39.0';

// Google Cloud依存関係
import { CloudTasksClient } from 'https://esm.sh/@google-cloud/tasks@4.0.0';
import { CloudSchedulerClient } from 'https://esm.sh/@google-cloud/scheduler@3.0.0';

// ウェブスクレイピング
import { chromium } from 'https://esm.sh/playwright-chromium@1.40.0';

// テストフレームワーク
import { assertEquals } from 'https://deno.land/std@0.208.0/assert/mod.ts';
```

### 外部サービス

- **Jリーグチケットサイト**: プライマリデータソース
- **LINE Messaging API**: ユーザー通知配信
- **Discord Webhooks**: システム監視とアラート
- **Google Cloud APIs**: Tasks、Scheduler、Runサービス

## パフォーマンス特性

### システムパフォーマンス仕様

| メトリック               | 目標パフォーマンス | 実装戦略                   |
| ------------------------ | ------------------ | -------------------------- |
| **スクレイピング成功率** | ~98%               | Cloud Run十分なリソース    |
| **通知レイテンシ**       | <30秒              | イベント駆動アーキテクチャ |
| **エラー復旧**           | 完全自動化         | Cloud Tasks自動リトライ    |
| **リソース使用率**       | 最適な割り当て     | GCP + Supabaseハイブリッド |
| **コスト効率性**         | 全無料枠内         | 最適化されたリソース使用   |

### スケーラビリティメトリック

- **想定負荷**: ~月10-20チケット、~月30-60通知
- **サポート規模**: 月最大1,000チケット、3,000通知まで
- **ボトルネック**: Jリーグサイトレート制限、LINE APIレート制限
- **将来のスケーリング**: 地域デプロイメント、キャッシュレイヤー

## セキュリティ考慮事項

### 認証アーキテクチャ

```typescript
// サービス認証マトリックス
const AUTH_MATRIX = {
  'Cloud Scheduler → Cloud Run': 'OIDCトークン（サービスアカウント）',
  'Cloud Run → Supabase': 'サービスロールキー',
  'Cloud Tasks → Edge Functions': 'サービスロールキー',
  'Edge Functions → LINE API': 'チャンネルアクセストークン',
  'Edge Functions → Discord': 'WebhookURL（認証なし）',
};
```

### セキュリティベストプラクティス

- **最小権限の原則**: 最小限のIAM権限
- **シークレット管理**: ローテーション付き環境変数
- **ネットワークセキュリティ**: 可能な限りプライベートサービス通信
- **入力検証**: 全体にわたるタイプセーフデータ処理
- **監査ログ**: 包括的セキュリティイベントログ

## コスト分析

### 月間コスト内訳（無料枠）

#### Google Cloud Platform

- **Cloud Run**: 60分実行 = 0円（18万vCPU秒無料枠内）
- **Cloud Scheduler**: 1ジョブ = 0円（3ジョブ無料枠内）
- **Cloud Tasks**: ~300タスク = 0円（月100万タスク無料枠内）
- **Cloud Logging**: <1GB = 0円（無料枠内）

#### Supabase

- **データベースストレージ**: <500MB = 0円
- **Edge Functions**: ~300呼び出し = 0円
- **APIリクエスト**: ~1,000リクエスト = 0円
- **帯域幅**: <1GB = 0円

#### 外部サービス

- **LINE Messaging API**: 無料（制限内プッシュメッセージ）
- **Discord Webhooks**: 無料

**月間総コスト**: 0円（完全に全無料枠内）

### 将来のコスト予測

- **10倍規模**（月100-200チケット）: 依然として無料枠内
- **100倍規模**（月1,000-2,000チケット）: 月推定5-10円
- **1000倍規模**: 有料枠必要、月推定50-100円

## 代替技術評価

### 検討した代替案

#### AWS Lambda + DynamoDB

- **長所**: 成熟したエコシステム、豊富な統合
- **短所**: コールドスタートレイテンシ、より複雑な価格体系、ベンダーロックイン
- **決定**: シンプルさのためGCP + Supabaseハイブリッドを選択

#### Azure Functions + Cosmos DB

- **長所**: 良好なエンタープライズ統合
- **短所**: より少ない寛大な無料枠、複雑性
- **決定**: このプロジェクトの要件に不適切

#### セルフホスト解決

- **長所**: 完全な制御、ベンダー依存なし
- **短所**: 運用オーバーヘッド、信頼性の懸念
- **決定**: このプロジェクトではマネージドサービスを優先

### 技術選定基準

1. **無料枠の適切性**: 無料枠内での運用必須
2. **信頼性**: 99%+のアップタイム要件
3. **開発者体験**: TypeScriptサポート、良いドキュメント
4. **スケーラビリティ**: アーキテクチャ変更なしで10倍成長に対応
5. **保守オーバーヘッド**: 最小限の運用要件
6. **コミュニティサポート**: アクティブなコミュニティ、定期的な更新

# アーキテクチャ設計書

## システム概要

urawa-support-hub
は浦和レッズサポーター向けの自動チケット監視・通知システムです。Jリーグのウェブサイトからチケット情報を取得し、データベースに保存し、チケット販売開始前に適切なタイミングでLINEグループに通知を送信します。

## システムアーキテクチャ

Google Cloud Platform サービスとSupabaseバックエンドを組み合わせたハイブリッドアーキテクチャを採用:

- **Google Cloud Run**: ウェブスクレイピング実行環境
- **Google Cloud Tasks**: 効率的な通知スケジューリング
- **Supabase**: データベースとEdge Functions通知機能
- **イベント駆動**: 改善された通知効率性
- **Clean Architecture**: 関心の分離が明確なパターン

## 1. ハイブリッドクリーンアーキテクチャ採用

### 1.1 アーキテクチャ概要

```
┌─────────────────────────────────────────────────────────┐
│                 Google Cloud Platform                   │
├─────────────────────────────────────────────────────────┤
│  Cloud Scheduler → Cloud Run → Cloud Tasks              │
│       ↓              ↓            ↓                      │
│   (12:00 JST)   (スクレイピング)  (スケジュール)          │
└─────────────────────────────────────────────────────────┘
                         ↓
┌─────────────────────────────────────────────────────────┐
│                      Supabase                          │
├─────────────────────────────────────────────────────────┤
│  PostgreSQL ← PostgREST API → Edge Functions           │
│      ↓           ↓                ↓                     │
│   (ストレージ)  (CRUD API)    (通知)                    │
└─────────────────────────────────────────────────────────┘
                                     ↓
┌─────────────────────────────────────────────────────────┐
│                  外部サービス                           │
├─────────────────────────────────────────────────────────┤
│            LINE API        Discord Webhook              │
└─────────────────────────────────────────────────────────┘
```

### 1.2 レイヤー構造

```
┌─────────────────────────────────────┐
│     インターフェース層               │  ← Cloud Run Service, Edge Functions
├─────────────────────────────────────┤
│     アプリケーション層               │  ← ScrapingService, NotificationService  
├─────────────────────────────────────┤
│        ドメイン層                   │  ← Entities: Ticket, NotificationHistory
│                                     │    Interfaces: TicketRepository
├─────────────────────────────────────┤
│     インフラストラクチャ層           │  ← RepositoryImpl, CloudTasks, Supabase
└─────────────────────────────────────┘
```

## 2. 各レイヤーの責務

### 2.1 インターフェース層 (Cloud Run + Edge Functions)

**責務**: 外部からのリクエスト処理とアプリケーションワークフローの発動

**主要コンポーネント**:

- **Cloud Run サービス**: ウェブスクレイピング実行環境
- **Supabase Edge Functions**: 通知配信とヘルスチェック

### 2.2 アプリケーション層 (サービス)

**責務**: ビジネス処理のオーケストレーションとレイヤー間の調整

**主要機能**:

- ビジネスワークフローのオーケストレーション
- 横断的関心事（ログ、監視）
- 外部サービス統合

### 2.3 ドメイン層 (コアビジネスロジック)

**責務**: ビジネスルールとドメイン知識のカプセル化

**主要原則**:

- 技術独立性
- ビジネスロジックのカプセル化
- インターフェース分離
- 設定駆動設計

### 2.4 インフラストラクチャ層 (技術実装)

**責務**: 技術機能と外部システム統合の提供

**主要コンポーネント**:

- データアクセス実装
- 外部サービスクライアント
- 技術ユーティリティ

## 3. データフロー

### 3.1 チケット監視フロー

1. Google Cloud Scheduler が毎日12:00 JSTにトリガー
2. Cloud Run でスクレイピング実行
3. データベースにチケット情報保存
4. 通知履歴レコード自動作成
5. Cloud Tasks で通知スケジューリング

### 3.2 通知配信フロー

1. Cloud Tasks がスケジュール時間に発動
2. Edge Functions で通知処理
3. LINE/Discord への並行通知
4. 配信状況の記録

## 4. 技術構成

### 4.1 Google Cloud Platform コンポーネント

| サービス            | 用途                 | 構成                          |
| ------------------- | -------------------- | ----------------------------- |
| **Cloud Run**       | スクレイピング実行   | 2GB メモリ、300秒タイムアウト |
| **Cloud Scheduler** | 日次トリガー         | 12:00 JST 実行                |
| **Cloud Tasks**     | 通知スケジューリング | 指数バックオフリトライ        |

### 4.2 Supabase コンポーネント

| サービス           | 用途             | 特徴                           |
| ------------------ | ---------------- | ------------------------------ |
| **PostgreSQL**     | データストレージ | RLS、自動トリガー              |
| **PostgREST API**  | CRUD操作         | 自動生成API                    |
| **Edge Functions** | 通知配信         | 512MB メモリ、60秒タイムアウト |

## 5. セキュリティ設計

### 5.1 サービス間認証

- **Cloud Scheduler → Cloud Run**: OIDCトークン
- **Cloud Run → Supabase**: サービスロールキー
- **Cloud Tasks → Edge Functions**: 認証ヘッダー
- **Edge Functions → 外部API**: APIキー

### 5.2 データ保護

- TLS暗号化
- 行レベルセキュリティ
- 入力検証
- ログのPII除外

## 6. パフォーマンス特性

### 6.1 リソース制約

| コンポーネント | メモリ | 実行時間 | 備考             |
| -------------- | ------ | -------- | ---------------- |
| Cloud Run      | 2GB    | 300秒    | スクレイピング用 |
| Edge Functions | 512MB  | 60秒     | 通知用           |

### 6.2 システム特性

| メトリック           | 特徴       | 理由             |
| -------------------- | ---------- | ---------------- |
| スクレイピング成功率 | 高安定性   | リソース制約解決 |
| 通知レイテンシ       | 低遅延     | イベント駆動設計 |
| エラー復旧           | 完全自動化 | Cloud Tasks活用  |

## 7. 運用特性

### 7.1 コスト構造

**月間運用コスト**: 0円（全サービス無料枠内）

- Google Cloud: 無料枠内
- Supabase: 無料枠内
- 外部API: 無料枠内

### 7.2 監視・アラート

- 構造化ログによる統一監視
- Discord経由の自動エラー通知
- Cloud Console でのメトリクス確認

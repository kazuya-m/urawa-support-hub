# urawa-support-hub 技術選定書

## 1. 実行環境

### 1.1 選定結果: Supabase Edge Functions

**選定理由:**

- Database・Functions・Authの完全統合
- TypeScript/Denoネイティブサポート
- 豊富な無料枠（月500,000回実行）
- 一元的な開発・デプロイ環境

**制約事項:**

- メモリ制限: 512MB
- 実行時間制限: 60秒
- Denoランタイム環境

**比較検討結果:**

| 項目           | Supabase Edge Functions | AWS Lambda     | Vercel Functions |
| -------------- | ----------------------- | -------------- | ---------------- |
| TypeScript対応 | ネイティブ              | 要設定         | ネイティブ       |
| メモリ制限     | 512MB                   | 3008MB         | 1008MB           |
| 実行時間制限   | 60秒                    | 15分           | 60秒             |
| 無料枠         | 月500,000回実行         | 月400,000GB-秒 | 月100GB-秒       |
| DB統合         | 完全統合                | 別途設定       | 別途設定         |
| 総合評価       | ⭐⭐⭐⭐⭐              | ⭐⭐⭐         | ⭐⭐⭐           |

## 2. データベース・アーキテクチャ

### 2.1 選定結果: Supabase PostgreSQL + クリーンアーキテクチャ

**選定理由:**

- Edge Functionsとの完全統合
- Row Level Security (RLS) による高セキュリティ  
- リアルタイム機能（将来の拡張性）
- 優秀なTypeScript SDK

**実装済みアーキテクチャ:**
- ✅ Domain Layer: Ticket, NotificationHistory エンティティ
- ✅ Infrastructure Layer: RepositoryImpl パターン
- ✅ 設定駆動設計: NOTIFICATION_TIMING_CONFIG

**無料枠制限:**

- データベース容量: 500MB
- プロジェクト制限: 2つまで（1アカウント内で2組織×2プロジェクト = 4プロジェクト可能）

**比較検討結果:**

| サービス            | 無料枠            | TypeScript対応 | リアルタイム | 統合性     |
| ------------------- | ----------------- | -------------- | ------------ | ---------- |
| Supabase PostgreSQL | 500MB             | ⭐⭐⭐⭐⭐     | あり         | ⭐⭐⭐⭐⭐ |
| Firebase Firestore  | 1GB/日50K読み込み | ⭐⭐⭐⭐       | あり         | ⭐⭐⭐     |
| PlanetScale         | 10GB              | ⭐⭐⭐⭐⭐     | なし         | ⭐⭐       |

## 3. スクレイピング技術

### 3.1 選定結果: Playwright

**選定理由:**

- Supabase Edge Functions + Deno環境での実績確認済み
- PuppeteerのEdge Functions実行エラーを回避
- 512MBメモリ制限内での安定動作
- 複数ブラウザ対応による将来性

**フォールバック戦略:**

1. **第1段階**: Playwright（JavaScript実行環境）
2. **第2段階**: fetch + DOMParser（軽量フォールバック）
3. **第3段階**: 複数URLパターンでの再試行

**比較検討結果:**

| 技術              | Supabase対応 | メモリ使用量 | 実行速度 | 信頼性     |
| ----------------- | ------------ | ------------ | -------- | ---------- |
| Playwright        | ⭐⭐⭐⭐⭐   | 中           | 高       | ⭐⭐⭐⭐⭐ |
| Puppeteer         | ⭐⭐         | 高           | 中       | ⭐⭐⭐     |
| fetch + DOMParser | ⭐⭐⭐⭐⭐   | 低           | 高       | ⭐⭐       |

## 4. 通知システム

### 4.1 選定結果: ハイブリッド通知システム

#### 4.1.1 ユーザー向け通知: LINE Messaging API

**選定理由:**

- 日本でのユーザー普及率
- グループチャット対応
- 豊富な無料枠（月1,000通）
- 高い到達率・信頼性

**実装状況:**

- ✅ Channel Access Token設定完了（GitHub Secrets管理）
- ✅ LINE Messaging API SDK統合済み

#### 4.1.2 システム監視通知: Discord Webhook

**選定理由:**

- 完全無料・無制限
- リッチなEmbed表示機能
- エラーレベル別カラーコーディング
- 開発者向けに最適化

**実装状況:**

- ✅ エラーハンドリング統一実装済み（handleSupabaseError）
- ✅ 共通エラー処理インフラ構築済み

**比較検討結果:**

| サービス           | 用途         | 無料枠     | 到達率     | 設定複雑さ | 機能性     |
| ------------------ | ------------ | ---------- | ---------- | ---------- | ---------- |
| LINE Messaging API | ユーザー通知 | 1,000通/月 | ⭐⭐⭐⭐⭐ | 低         | ⭐⭐⭐     |
| Discord Webhook    | システム監視 | 制限なし   | ⭐⭐⭐⭐   | 低         | ⭐⭐⭐⭐⭐ |
| Slack Webhook      | 代替案       | 制限なし   | ⭐⭐⭐⭐   | 低         | ⭐⭐⭐     |

#### 4.1.3 通知ルーティング戦略

```
[エラー発生] → [ErrorNotificationRouter]
    ├── info: ログのみ
    ├── warning: Discord通知
    ├── error: Discord通知 + データベースログ
    └── critical: Discord通知 + データベースログ + スタックトレース

[チケット情報] → [LINE通知] → [ユーザーグループチャット]
```

## 5. スケジューラー

### 5.1 選定結果: Supabase pg_cron

**選定理由:**

- PostgreSQL内蔵の高信頼性cron機能
- Supabaseエコシステムとの完全統合
- 追加コスト不要
- 複雑な外部設定不要

**スケジュール設定:**

```sql
-- 毎日12:00 JST (03:00 UTC) でチケットチェック
SELECT cron.schedule('daily-ticket-check', '0 3 * * *', 'SELECT ...');

-- 5分間隔で通知チェック
SELECT cron.schedule('notification-check', '*/5 * * * *', 'SELECT ...');
```

**比較検討結果:**

| サービス              | コスト | 設定複雑さ | 信頼性     | 統合性     |
| --------------------- | ------ | ---------- | ---------- | ---------- |
| Supabase pg_cron      | 無料   | 低         | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ |
| GitHub Actions        | 無料   | 中         | ⭐⭐⭐⭐   | ⭐⭐       |
| AWS CloudWatch Events | 有料   | 高         | ⭐⭐⭐⭐⭐ | ⭐⭐       |

## 6. 開発・運用ツール

### 6.1 開発環境: Deno + TypeScript

**選定理由:**

- Supabase Edge Functionsの標準ランタイム
- 標準ライブラリの充実
- モダンなJavaScript/TypeScript機能
- セキュリティファースト設計

### 6.2 パッケージ管理: ESM + Import Maps

**選定理由:**

- Denoの標準的なパッケージ管理
- バージョン固定による安定性
- CDN経由での高速読み込み

### 6.3 CI/CD: Git-based デプロイメント

**選定理由:**

- Supabase CLIとの統合
- シンプルなデプロイフロー
- バージョン管理との連携

## 7. コスト分析

### 7.1 月間運用コスト見積り

- **Supabase**: $0.00（無料枠：DB 500MB + Functions 500,000回実行）
- **LINE Messaging API**: $0.00（無料枠：1,000通/月）
- **Discord Webhook**: $0.00（完全無料・無制限）
- **推定使用量**:
  - DB使用量: 10MB未満
  - Functions実行: 約8,760回/月
  - LINE通知: 約20通/月
  - Discord通知: 約50通/月（エラー監視含む）

**総計: $0.00/月（全て無料枠内で運用可能）**

### 7.2 スケーラビリティ時のコスト

- **Supabase Pro**: $25/月（DB容量無制限、より多くの実行回数）
- **LINE有料プラン**: 追加メッセージ 1通あたり約0.3円
- **Discord**: 永続的に無料

## 8. 長期戦略

### 8.1 Supabase無料枠活用戦略

- **現在**: urawa-support-hub（1/2プロジェクト使用）
- **将来**: 2組織活用で最大4プロジェクト無料運用
- **拡張時**: 用途に応じたハイブリッド戦略
  - Supabase（メイン機能）
  - Firebase（補助機能）
  - PlanetScale（データ集約型機能）

### 8.2 技術スタック進化対応

- **Deno**: 継続的なアップデート対応
- **Playwright**: 新機能・パフォーマンス改善の活用
- **Supabase**: 新機能（AI統合等）の検討

## 9. リスク評価・対策

### 9.1 技術的リスク

| リスク               | 影響度 | 発生確率 | 対策                               |
| -------------------- | ------ | -------- | ---------------------------------- |
| Supabase障害         | 高     | 低       | ローカル開発環境、バックアップ戦略 |
| Playwright実行エラー | 中     | 中       | フォールバック機能、軽量代替手段   |
| LINE API制限         | 中     | 低       | 使用量監視、代替通知手段           |

### 9.2 運用リスク

| リスク           | 影響度 | 発生確率 | 対策                           |
| ---------------- | ------ | -------- | ------------------------------ |
| 無料枠超過       | 中     | 低       | 使用量監視、効率化             |
| サイト構造変更   | 高     | 中       | 複数セレクタ、柔軟な設定       |
| 長期メンテナンス | 低     | 高       | ドキュメント整備、設計の簡素化 |

## 10. 技術選定まとめ

### 10.1 選定技術スタック

```
Frontend: なし（通知のみ）
Backend: Supabase Edge Functions (Deno + TypeScript)
Database: Supabase PostgreSQL
Scraping: Playwright
User Notification: LINE Messaging API
System Monitoring: Discord Webhook
Scheduler: pg_cron
Development: Deno + TypeScript + VS Code
Deployment: Supabase CLI + Git
```

### 10.2 選定の決定要因

1. **統合性**: Supabaseエコシステムの完全活用
2. **コスト効率**: 全機能無料枠内での運用
3. **保守性**: シンプルで理解しやすい構成
4. **拡張性**: 将来の機能追加に対応可能
5. **信頼性**: 実績のある技術の組み合わせ
6. **監視性**: システム状態の即座な把握

この技術選定により、安定性・コスト効率・保守性・監視性を兼ね備えたシステムを構築できます。

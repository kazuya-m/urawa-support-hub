# 開発環境用Docker Compose設定
# 本番環境（Cloud Run）では使用されません

services:
  urawa-support-hub-app:
    build:
      context: .
      dockerfile: Dockerfile.dev
    ports:
      - '8080:8080'
    volumes:
      # ソースコードをマウント（ホットリロード用）
      - ./src:/app/src
      - ./tests:/app/tests
      - ./scripts:/app/scripts
    env_file:
      - .env.local
    environment:
      - NODE_ENV=development
      - PORT=8080
      - SUPABASE_URL=http://host.docker.internal:54321
      - CLOUD_TASKS_EMULATOR_HOST=cloud-tasks-emulator:8123
    # Supabaseローカル環境との連携
    extra_hosts:
      - 'host.docker.internal:host-gateway'
    # Cloud Tasks Emulatorへの依存
    depends_on:
      cloud-tasks-emulator:
        condition: service_started
    # ヘルスチェック
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:8080/health']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  cloud-tasks-emulator:
    image: ghcr.io/aertje/cloud-tasks-emulator:1.2.0
    command: -host 0.0.0.0 -port 8123 -queue projects/dev-project/locations/asia-northeast1/queues/notification-queue
    ports:
      - '8123:8123'
    healthcheck:
      test: ['CMD', 'wget', '--spider', '-q', 'http://localhost:8123']
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s
